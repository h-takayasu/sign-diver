<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Sign Diverã®ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã€‚åˆ¶é™æ™‚é–“ãªã—ã§æŒ‡æ–‡å­—ã‚’å­¦ç¿’ã§ãã¾ã™ã€‚">
  <meta name="robots" content="noindex">
  <title>ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ - æŒ‡æ–‡å­—ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ  Sign Diver</title>
  
  <!-- Three.js ã¨ VRM -->
  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.159.0/examples/jsm/",
        "@pixiv/three-vrm": "https://cdn.jsdelivr.net/npm/@pixiv/three-vrm@2.0.9/lib/three-vrm.module.js"
      }
    }
  </script>
  
  <!-- TensorFlow.js -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
  <!-- MediaPipe Hands -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils@0.3.1640029074/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js" crossorigin="anonymous"></script>
  
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Segoe UI', 'Arial', sans-serif;
      background: linear-gradient(135deg, #e0f7ff 0%, #b3e5fc 50%, #81d4fa 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      color: #1a237e;
      position: relative;
      overflow-x: hidden;
    }
    
    /* èƒŒæ™¯ã®æ³¡ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        radial-gradient(circle at 20% 80%, rgba(255,255,255,0.3) 3px, transparent 3px),
        radial-gradient(circle at 80% 20%, rgba(255,255,255,0.25) 4px, transparent 4px),
        radial-gradient(circle at 40% 40%, rgba(255,255,255,0.3) 2px, transparent 2px),
        radial-gradient(circle at 60% 70%, rgba(255,255,255,0.25) 5px, transparent 5px);
      background-size: 200px 200px, 300px 300px, 250px 250px, 350px 350px;
      animation: bubbleFloat 25s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    
    @keyframes bubbleFloat {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(10px, -20px); }
      50% { transform: translate(-5px, -40px); }
      75% { transform: translate(15px, -30px); }
    }
    
    .container {
      max-width: 1100px;
      width: 100%;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(100, 181, 246, 0.3);
      border: 2px solid rgba(100, 181, 246, 0.3);
      position: relative;
      z-index: 1;
    }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    .page-header {
      text-align: center;
      margin-bottom: 12px;
    }
    
    .page-title {
      font-size: 24px;
      font-weight: 800;
      color: #1a237e;
      margin-bottom: 3px;
      text-shadow: 2px 2px 0 rgba(100,181,246,0.3);
    }
    
    .page-subtitle {
      font-size: 13px;
      color: #4a148c;
      font-weight: 600;
    }
    
    /* ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰ */
    .mode-selector {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-bottom: 12px;
    }
    
    .mode-btn {
      padding: 6px 16px;
      border: 2px solid rgba(100,181,246,0.4);
      background: rgba(255,255,255,0.7);
      color: #1a237e;
      border-radius: 50px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .mode-btn.active {
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      color: white;
      border-color: #42a5f5;
      box-shadow: 0 4px 12px rgba(100,181,246,0.4);
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
    .practice-main {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    /* å·¦å´ï¼šã‚µãƒ³ãƒ—ãƒ«ã‚¨ãƒªã‚¢ */
    .sample-area {
      flex: 1;
      background: linear-gradient(135deg, rgba(179,229,252,0.3), rgba(129,212,250,0.3));
      border: 2px solid rgba(100,181,246,0.3);
      border-radius: 16px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 240px;
      position: relative;
    }
    
    #vrm-canvas {
      width: 100%;
      height: 200px;
      border-radius: 12px;
      background: #fff8e1;
    }
    
    .placeholder {
      text-align: center;
      color: #4a148c;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .placeholder-icon {
      font-size: 70px;
      margin-bottom: 8px;
      opacity: 0.7;
    }
    
    .placeholder-text {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .placeholder-hint {
      font-size: 12px;
      color: #6a1b9a;
      font-weight: 600;
      margin-top: 8px;
      padding: 4px 10px;
      background: rgba(206,147,216,0.2);
      border-radius: 8px;
      line-height: 1.4;
      max-width: 100%;
      word-wrap: break-word;
      text-align: center;
    }
    
    .placeholder-note {
      font-size: 11px;
      opacity: 0.6;
    }
    
    /* å³å´ï¼šã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ */
    .camera-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .camera-wrapper {
      position: relative;
      background: #000;
      border-radius: 16px;
      overflow: hidden;
      border: 2px solid rgba(100,181,246,0.3);
      height: 180px;
    }
    
    video {
      display: none;
    }
    
    canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      border-radius: 14px;
    }
    
    .camera-status {
      position: absolute;
      top: 8px;
      left: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .camera-status.loading {
      background: rgba(255,152,0,0.9);
    }
    
    .camera-status.ready {
      background: rgba(76,175,80,0.9);
    }
    
    /* èªè­˜çµæœ */
    .recognition-result {
      background: rgba(255,255,255,0.8);
      border: 2px solid rgba(100,181,246,0.3);
      border-radius: 16px;
      padding: 10px;
      text-align: center;
      transition: background 0.3s, border-color 0.3s;
      height: 160px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .recognition-result.disabled {
      background: rgba(200,200,200,0.3);
      border-color: rgba(150,150,150,0.3);
    }
    
    .result-label {
      font-size: 11px;
      color: #4a148c;
      margin-bottom: 4px;
      font-weight: 600;
    }
    
    .recognized-char {
      font-size: 42px;
      font-weight: bold;
      color: #1a237e;
      margin-bottom: 4px;
      line-height: 1;
    }
    
    .recognition-result.disabled .recognized-char {
      color: #999;
    }
    
    .confidence {
      font-size: 13px;
      color: #4a148c;
      margin-bottom: 6px;
    }
    
    .recognition-result.disabled .confidence {
      color: #999;
    }
    
    .status-message {
      font-size: 14px;
      font-weight: 700;
      padding: 6px 12px;
      border-radius: 50px;
      display: inline-block;
    }
    
    .status-message.correct {
      background: rgba(76,175,80,0.2);
      color: #2e7d32;
    }
    
    .status-message.incorrect {
      background: rgba(239,83,80,0.2);
      color: #c62828;
    }
    
    .status-message.waiting {
      background: rgba(100,181,246,0.2);
      color: #0288d1;
    }
    
    .status-message.info {
      background: rgba(158,158,158,0.2);
      color: #616161;
      font-size: 11px;
      font-weight: 600;
      line-height: 1.4;
      padding: 8px 12px;
      white-space: pre-line;
    }
    
    /* æ–‡å­—é¸æŠ */
    .character-selector {
      background: rgba(255,255,255,0.8);
      border: 2px solid rgba(100,181,246,0.3);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    /* ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰UI */
    .random-mode-ui {
      background: rgba(255,255,255,0.8);
      border: 2px solid rgba(100,181,246,0.3);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 12px;
    }
    
    .random-description {
      text-align: center;
      color: #4a148c;
      padding: 12px;
    }
    
    .random-description p {
      font-size: 14px;
      font-weight: 600;
      margin: 6px 0;
      line-height: 1.6;
    }
    
    .stats-display {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 12px;
    }
    
    .stat-item {
      background: rgba(100,181,246,0.1);
      border: 2px solid rgba(100,181,246,0.3);
      border-radius: 12px;
      padding: 10px 16px;
      text-align: center;
      min-width: 80px;
    }
    
    .stat-label {
      font-size: 11px;
      color: #4a148c;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 900;
      color: #1a237e;
    }
    
    .random-controls {
      display: flex;
      gap: 10px;
      justify-content: center;
    }
    
    .control-btn {
      padding: 10px 28px;
      border: 2px solid rgba(100,181,246,0.4);
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      color: white;
      border-radius: 50px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: all 0.3s;
      box-shadow: 0 4px 12px rgba(100,181,246,0.4);
    }
    
    .control-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(100,181,246,0.6);
    }
    
    .control-btn.secondary {
      background: rgba(255,255,255,0.9);
      color: #1a237e;
      box-shadow: none;
      width: 200px;
    }
    
    .control-btn.secondary:hover {
      background: rgba(239,83,80,0.2);
      border-color: #ef5350;
      color: #c62828;
    }
    
    .selector-section {
      margin-bottom: 10px;
    }
    
    .selector-section:last-child {
      margin-bottom: 0;
    }
    
    .selector-label {
      font-size: 12px;
      color: #4a148c;
      font-weight: 700;
      margin-bottom: 6px;
      text-align: center;
    }
    
    .current-char-display {
      font-size: 48px;
      font-weight: 900;
      color: #1a237e;
      text-align: center;
      margin-bottom: 10px;
      text-shadow: 2px 2px 0 rgba(100,181,246,0.3);
      line-height: 1;
    }
    
    /* è¡Œé¸æŠãƒœã‚¿ãƒ³ */
    .row-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 4px;
    }
    
    .row-btn {
      min-width: 40px;
      padding: 6px 12px;
      border: 2px solid rgba(100,181,246,0.4);
      background: rgba(255,255,255,0.9);
      color: #1a237e;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: all 0.2s;
    }
    
    .row-btn:hover {
      background: rgba(100,181,246,0.2);
      transform: translateY(-2px);
    }
    
    .row-btn.active {
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      color: white;
      border-color: #42a5f5;
      box-shadow: 0 4px 12px rgba(100,181,246,0.5);
    }
    
    /* æ–‡å­—ãƒœã‚¿ãƒ³ */
    .char-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
      flex-wrap: wrap;
      max-width: 300px;
      margin: 0 auto;
    }
    
    .char-btn {
      width: 40px;
      height: 40px;
      border: 2px solid rgba(100,181,246,0.4);
      background: rgba(255,255,255,0.9);
      color: #1a237e;
      border-radius: 8px;
      cursor: pointer;
      font-size: 17px;
      font-weight: 700;
      transition: all 0.2s;
    }
    
    .char-btn:hover {
      background: rgba(100,181,246,0.2);
      transform: translateY(-2px);
    }
    
    .char-btn.active {
      background: linear-gradient(135deg, #ce93d8, #ba68c8);
      color: white;
      border-color: #ba68c8;
      box-shadow: 0 4px 12px rgba(206,147,216,0.5);
    }
    
    /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .navigation {
      display: flex;
      gap: 8px;
      justify-content: center;
    }
    
    .nav-btn {
      padding: 8px 20px;
      border: 2px solid rgba(100,181,246,0.4);
      background: rgba(255,255,255,0.9);
      color: #1a237e;
      border-radius: 50px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      transition: all 0.3s;
    }
    
    .nav-btn:hover {
      background: rgba(100,181,246,0.2);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(100,181,246,0.3);
    }
    
    .nav-btn.primary {
      background: linear-gradient(135deg, #66bb6a, #4caf50);
      color: white;
      border-color: #4caf50;
    }
    
    .nav-btn.primary:hover {
      box-shadow: 0 6px 16px rgba(76,175,80,0.4);
    }
    
    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .site-footer {
      text-align: center;
      margin-top: 12px;
      position: relative;
      z-index: 1;
    }
    
    .site-footer a {
      color: #0288d1;
      text-decoration: none;
      font-size: 12px;
      font-weight: 600;
      transition: color 0.2s;
    }
    
    .site-footer a:hover {
      color: #0277bd;
    }
    #vrm-canvas {
      position: relative;
      width: 100%;
      height: 100%;
      min-height: 500px;
    }
    
    /* VRMãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .vrm-loading-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(160deg, #0a1628 0%, #0d2244 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 50;
      gap: 18px;
    }
    .vrm-loading-overlay.hidden {
      display: none;
    }
    .vrm-loading-spinner {
      width: 48px; height: 48px;
      border: 4px solid rgba(79,172,254,0.2);
      border-top-color: #4facfe;
      border-radius: 50%;
      animation: vrmSpin 0.9s linear infinite;
    }
    @keyframes vrmSpin {
      to { transform: rotate(360deg); }
    }
    .vrm-loading-text {
      color: rgba(255,255,255,0.75);
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 1px;
    }
    .vrm-loading-sub {
      color: rgba(255,255,255,0.35);
      font-size: 11px;
      letter-spacing: 0.5px;
    }

    /* ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ­ãƒƒã‚¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”¨ï¼‰ */
    .vrm-blackout-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
      box-sizing: border-box;
    }
    
    .vrm-blackout-overlay.show {
      display: flex;
    }
    
    .blackout-content {
      text-align: center;
      color: white;
      max-width: 400px;
    }
    
    .blackout-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .blackout-title {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 16px;
      color: #1976d2;
    }
    
    .blackout-message {
      font-size: 16px;
      line-height: 1.6;
      margin-bottom: 20px;
      color: #e0e0e0;
    }
    
    /* VRMã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .vrm-overlay-controls {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(240, 246, 255, 0.93);
      backdrop-filter: blur(10px);
      padding: 10px 12px;
      box-shadow: 0 -4px 20px rgba(26, 58, 92, 0.12);
      z-index: 10;
    }
    
    .vrm-control-hint {
      text-align: center;
      font-size: 10px;
      color: #4a6080;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    .vrm-animation-controls {
      margin: 6px 0;
      display: flex;
      gap: 6px;
      justify-content: center;
    }
    
    .vrm-control-button {
      padding: 8px 14px;
      background: linear-gradient(135deg, #64b5f6, #1976d2);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(25,118,210,0.3);
    }
    
    .vrm-control-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(25,118,210,0.5);
    }
    
    .vrm-control-button:active {
      transform: translateY(0);
    }
    
    .vrm-slider-container {
      margin: 6px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .vrm-slider-container label {
      font-weight: bold;
      min-width: 60px;
      text-align: right;
      color: #1a3a5c;
      font-size: 11px;
    }
    
    .vrm-slider-container input[type="range"] {
      width: 180px;
      height: 6px;
      border-radius: 3px;
      background: #bbdefb;
      outline: none;
      -webkit-appearance: none;
    }
    
    .vrm-slider-container input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1976d2;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .vrm-slider-container input[type="range"]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #1976d2;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .vrm-slider-container span {
      min-width: 70px;
      font-weight: bold;
      color: #1a3a5c;
      font-size: 11px;
    }
    
  </style>
</head>
<body>
  <!-- ã‚«ãƒ¡ãƒ©ä½¿ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="cameraModal" style="
    position:fixed; inset:0; z-index:9999;
    background:rgba(10,20,60,0.75);
    display:flex; align-items:center; justify-content:center;
    backdrop-filter:blur(6px);
  ">
    <div style="
      background:white; border-radius:20px; padding:32px 28px;
      max-width:400px; width:90%; text-align:center;
      box-shadow:0 20px 60px rgba(0,0,100,0.3);
      border:2px solid rgba(100,181,246,0.4);
    ">
      <div style="font-size:52px; margin-bottom:12px;">ğŸ“·</div>
      <h2 style="font-size:19px; font-weight:800; color:#1a237e; margin-bottom:12px;">
        ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ
      </h2>
      <p style="font-size:13px; color:#37474f; line-height:1.8; margin-bottom:24px;">
        ã‚«ãƒ¡ãƒ©ã‚’ä½¿ã†ã¨æ‰‹ã®å‹•ãã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§èªè­˜ã—ã€<br>
        æŒ‡æ–‡å­—ã®æ­£èª¤åˆ¤å®šãŒã§ãã¾ã™ã€‚<br>
        <strong style="color:#1565c0;">ã‚«ãƒ¡ãƒ©ãªã—ã§ã‚‚ç·´ç¿’ãƒšãƒ¼ã‚¸ã¯åˆ©ç”¨ã§ãã¾ã™ã€‚</strong>
      </p>
      <div style="display:flex; gap:12px; justify-content:center; margin-bottom:16px;">
        <button id="cameraYesBtn" style="
          padding:12px 30px; border:none; border-radius:50px; cursor:pointer;
          background:linear-gradient(135deg,#64b5f6,#1976d2);
          color:white; font-size:15px; font-weight:700;
          box-shadow:0 4px 14px rgba(25,118,210,0.4);
        ">âœ… ä½¿ã†</button>
        <button id="cameraNoBtn" style="
          padding:12px 30px; border:2px solid #ccc; border-radius:50px; cursor:pointer;
          background:white; color:#555; font-size:15px; font-weight:700;
        ">ğŸš« ä½¿ã‚ãªã„</button>
      </div>
      <p style="font-size:11px; color:#aaa; line-height:1.6;">
        ã€Œä½¿ã‚ãªã„ã€ã‚’é¸ã‚“ã å ´åˆã€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚Œã°<br>å†åº¦é¸æŠã§ãã¾ã™ã€‚
      </p>
    </div>
  </div>

  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="page-header">
      <h1 class="page-title">ğŸ“ ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰</h1>
      <p class="page-subtitle">åˆ¶é™æ™‚é–“ãªã—ã§æŒ‡æ–‡å­—ã‚’å­¦ç¿’ã—ã‚ˆã†</p>
    </div>
    
    <!-- ãƒ¢ãƒ¼ãƒ‰é¸æŠï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼šç¾åœ¨ã¯å€‹åˆ¥ç·´ç¿’ã®ã¿ï¼‰ -->
    <div class="mode-selector">
      <button class="mode-btn active" id="modeIndividual">å€‹åˆ¥ç·´ç¿’</button>
      <button class="mode-btn" id="modeRandom">ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œ</button>
    </div>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ -->
    <div class="practice-main">
      <!-- å·¦å´ï¼šã‚µãƒ³ãƒ—ãƒ«ã‚¨ãƒªã‚¢ -->
      <div class="sample-area">
        <div id="vrm-canvas">
          <!-- VRMãƒ­ãƒ¼ãƒ‰ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
          <div class="vrm-loading-overlay" id="vrmLoadingOverlay">
            <div class="vrm-loading-spinner"></div>
            <div class="vrm-loading-text">ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            <div class="vrm-loading-sub">åˆå›ã¯å°‘ã—ãŠå¾…ã¡ãã ã•ã„</div>
          </div>

          <!-- ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆãƒ­ãƒƒã‚¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç”¨ï¼‰ -->
          <div class="vrm-blackout-overlay" id="vrm-blackout">
            <div class="blackout-content">
              <div class="blackout-icon">ğŸ”’</div>
              <div class="blackout-title" id="blackout-title">ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™</div>
              <div class="blackout-message" id="blackout-message">è§£æ”¾æ¡ä»¶ã‚’æº€ãŸã™ã¨ã”è¦§ã„ãŸã ã‘ã¾ã™ã€‚</div>
            </div>
          </div>
          
          <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤UI -->
          <div class="vrm-overlay-controls">
            <div class="vrm-control-hint">å·¦ã‚¯ãƒªãƒƒã‚¯:å›è»¢ | å³ã‚¯ãƒªãƒƒã‚¯:ç§»å‹• | ãƒ›ã‚¤ãƒ¼ãƒ«:ã‚ºãƒ¼ãƒ  | ç”»é¢ã‚¯ãƒªãƒƒã‚¯:å†ç”Ÿ/åœæ­¢</div>
            
            <div class="vrm-animation-controls">
              <button id="vrm-playBtn" class="vrm-control-button">â–¶ å†ç”Ÿ</button>
              <button id="vrm-pauseBtn" class="vrm-control-button">â¸ åœæ­¢</button>
              <button id="vrm-resetCameraBtn" class="vrm-control-button">ğŸ“· è¦–ç‚¹ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
            
            <div class="vrm-slider-container">
              <label for="vrm-seekSlider">å†ç”Ÿä½ç½®:</label>
              <input type="range" id="vrm-seekSlider" min="0" max="100" value="0" step="0.1">
              <span id="vrm-timeDisplay">0.0s / 0.0s</span>
            </div>
            
            <div class="vrm-slider-container">
              <label for="vrm-speedSlider">é€Ÿåº¦:</label>
              <input type="range" id="vrm-speedSlider" min="0.1" max="2" value="1" step="0.1">
              <span id="vrm-speedDisplay">1.0x</span>
            </div>
          </div>
        </div>
        <div class="placeholder-hint" id="charHint">ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆã®a</div>
      </div>
      
      <!-- å³å´ï¼šã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ -->
      <div class="camera-area">
        <div class="camera-wrapper">
          <video id="video" playsinline></video>
          <canvas id="canvas"></canvas>
          <div class="camera-status loading" id="cameraStatus">ã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...</div>
          <div id="cameraOffOverlay" style="
            display:none; position:absolute; inset:0; border-radius:14px;
            background:rgba(20,20,50,0.82);
            flex-direction:column; align-items:center; justify-content:center;
            gap:8px; color:white; text-align:center; padding:16px;
          ">
            <span style="font-size:36px;">ğŸ“·</span>
            <span style="font-size:13px; font-weight:700;">ã‚«ãƒ¡ãƒ©æœªä½¿ç”¨ãƒ¢ãƒ¼ãƒ‰</span>
            <span style="font-size:11px; opacity:0.7;">ãƒªãƒ­ãƒ¼ãƒ‰ã§å†é¸æŠã§ãã¾ã™</span>
          </div>
        </div>
        
        <div class="recognition-result">
          <div class="result-label">èªè­˜çµæœ</div>
          <div class="recognized-char" id="recognizedChar">-</div>
          <div class="confidence" id="confidence">-</div>
          <div class="status-message waiting" id="statusMessage">æ‰‹ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„</div>
        </div>
      </div>
    </div>
    
    <!-- æ–‡å­—é¸æŠ -->
    <div class="character-selector" id="characterSelector">
      <div class="current-char-display" id="currentCharDisplay">ã‚</div>
      
      <!-- è¡Œé¸æŠ -->
      <div class="selector-section">
        <div class="selector-label">è¡Œã‚’é¸æŠ</div>
        <div class="row-buttons" id="rowButtons">
          <!-- JavaScriptã§ç”Ÿæˆ -->
        </div>
      </div>
      
      <!-- æ–‡å­—é¸æŠ -->
      <div class="selector-section">
        <div class="selector-label">æ–‡å­—ã‚’é¸æŠ <span id="currentRowLabel">ï¼ˆã€Œã‚è¡Œã€ã‚’é¸æŠä¸­ï¼‰</span></div>
        <div class="char-buttons" id="charButtons">
          <!-- JavaScriptã§ç”Ÿæˆ -->
        </div>
      </div>
    </div>
    
    <!-- ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ç”¨UI -->
    <div class="random-mode-ui" id="randomModeUI" style="display: none;">
      <div class="current-char-display" id="randomCharDisplay">ã‚</div>
      
      <!-- èª¬æ˜æ–‡ -->
      <div class="random-description">
        <p>ãƒ©ãƒ³ãƒ€ãƒ ã«å‡ºé¡Œã•ã‚Œã‚‹æŒ‡æ–‡å­—ã‚’ä½œã£ã¦ãã ã•ã„ã€‚</p>
        <p>æ­£è§£ã™ã‚‹ã¨è‡ªå‹•çš„ã«æ¬¡ã®æ–‡å­—ã«é€²ã¿ã¾ã™ã€‚</p>
      </div>
    </div>
    
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="navigation">
      <button class="nav-btn" id="prevBtn">â† å‰ã®æ–‡å­—</button>
      <button class="nav-btn primary" onclick="location.href='index.html'">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
      <button class="nav-btn" id="nextBtn">æ¬¡ã®æ–‡å­— â†’</button>
    </div>
  </div>
  
  <footer class="site-footer">
    <div style="margin-bottom: 8px; text-align: center;">
      <a href="about_yubimoji.html" style="margin: 0 12px;">æŒ‡æ–‡å­—ã¨ã¯ï¼Ÿ</a>
      <span style="color: rgba(2,136,209,0.3);">|</span>
      <a href="about_signdiver.html" style="margin: 0 12px;">Sign Diverã¨ã¯ï¼Ÿ</a>
      <span style="color: rgba(2,136,209,0.3);">|</span>
      <a href="terms.html" style="margin: 0 12px;">åˆ©ç”¨è¦ç´„</a>
      <span style="color: rgba(2,136,209,0.3);">|</span>
      <a href="privacy.html" style="margin: 0 12px;">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
    </div>
    <a href="https://www.youtube.com/@Katsuo_Shuwa_Doga" target="_blank" rel="noopener noreferrer">
      â–¶ @KatsuoShuwaDoga
    </a>
  </footer>

  <script type="module">
    // ==========================================
    // æ–‡å­—ãƒ‡ãƒ¼ã‚¿å®šç¾©
    // ==========================================
    const CHARACTER_ROWS = {
      'ã‚': { label: 'ã‚è¡Œ', chars: ['ã‚', 'ã„', 'ã†', 'ãˆ', 'ãŠ'] },
      'ã‹': { label: 'ã‹è¡Œ', chars: ['ã‹', 'ã', 'ã', 'ã‘', 'ã“', 'ãŒ', 'ã', 'ã', 'ã’', 'ã”'] },
      'ã•': { label: 'ã•è¡Œ', chars: ['ã•', 'ã—', 'ã™', 'ã›', 'ã', 'ã–', 'ã˜', 'ãš', 'ãœ', 'ã'] },
      'ãŸ': { label: 'ãŸè¡Œ', chars: ['ãŸ', 'ã¡', 'ã¤', 'ã¦', 'ã¨', 'ã ', 'ã¢', 'ã¥', 'ã§', 'ã©'] },
      'ãª': { label: 'ãªè¡Œ', chars: ['ãª', 'ã«', 'ã¬', 'ã­', 'ã®'] },
      'ã¯': { label: 'ã¯è¡Œ', chars: ['ã¯', 'ã²', 'ãµ', 'ã¸', 'ã»', 'ã°', 'ã³', 'ã¶', 'ã¹', 'ã¼', 'ã±', 'ã´', 'ã·', 'ãº', 'ã½'] },
      'ã¾': { label: 'ã¾è¡Œ', chars: ['ã¾', 'ã¿', 'ã‚€', 'ã‚', 'ã‚‚'] },
      'ã‚„': { label: 'ã‚„è¡Œ', chars: ['ã‚„', 'ã‚†', 'ã‚ˆ'] },
      'ã‚‰': { label: 'ã‚‰è¡Œ', chars: ['ã‚‰', 'ã‚Š', 'ã‚‹', 'ã‚Œ', 'ã‚'] },
      'ã‚': { label: 'ã‚è¡Œ', chars: ['ã‚', 'ã‚’', 'ã‚“'] },
      'å°': { label: 'å°æ–‡å­—', chars: ['ã', 'ãƒ', 'ã…', 'ã‡', 'ã‰', 'ã‚ƒ', 'ã‚…', 'ã‚‡', 'ã£', 'ãƒ¼'] },
      'S': { label: 'ã‚¹ãƒšã‚·ãƒ£ãƒ«', chars: ['1', '2', '3', '4', '5'] }
    };
    
    // ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸åã®å®šç¾©
    const SPECIAL_STAGE_NAMES = {
      '1': 'ä¸­å±¤',
      '2': 'è–„æš®å±¤',
      '3': 'æ·±æµ·',
      '4': 'è¶…æ·±æµ·',
      '5': '???'
    };
    
    // ã²ã‚‰ãŒãª â†’ GLBãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const CHAR_TO_GLB = {
      'ã‚': '01_a.glb', 'ã„': '02_i.glb', 'ã†': '03_u.glb', 'ãˆ': '04_e.glb', 'ãŠ': '05_o.glb',
      'ã‹': '06_ka.glb', 'ã': '07_ki.glb', 'ã': '08_ku.glb', 'ã‘': '09_ke.glb', 'ã“': '10_ko.glb',
      'ã•': '11_sa.glb', 'ã—': '12_shi.glb', 'ã™': '13_su.glb', 'ã›': '14_se.glb', 'ã': '15_so.glb',
      'ãŸ': '16_ta.glb', 'ã¡': '17_chi.glb', 'ã¤': '18_tsu.glb', 'ã¦': '19_te.glb', 'ã¨': '20_to.glb',
      'ãª': '21_na.glb', 'ã«': '22_ni.glb', 'ã¬': '23_nu.glb', 'ã­': '24_ne.glb', 'ã®': '25_no.glb',
      'ã¯': '26_ha.glb', 'ã²': '27_hi.glb', 'ãµ': '28_fu.glb', 'ã¸': '29_he.glb', 'ã»': '30_ho.glb',
      'ã¾': '31_ma.glb', 'ã¿': '32_mi.glb', 'ã‚€': '33_mu.glb', 'ã‚': '34_me.glb', 'ã‚‚': '35_mo.glb',
      'ã‚„': '36_ya.glb', 'ã‚†': '37_yu.glb', 'ã‚ˆ': '38_yo.glb',
      'ã‚‰': '39_ra.glb', 'ã‚Š': '40_ri.glb', 'ã‚‹': '41_ru.glb', 'ã‚Œ': '42_re.glb', 'ã‚': '43_ro.glb',
      'ã‚': '44_wa.glb', 'ã‚’': '45_wo.glb', 'ã‚“': '46_n.glb',
      'ãŒ': '48_ga.glb', 'ã': '49_gi.glb', 'ã': '50_gu.glb', 'ã’': '51_ge.glb', 'ã”': '52_go.glb',
      'ã–': '53_za.glb', 'ã˜': '54_ji.glb', 'ãš': '55_zu.glb', 'ãœ': '56_ze.glb', 'ã': '57_zo.glb',
      'ã ': '58_da.glb', 'ã¢': '59_di.glb', 'ã¥': '60_du.glb', 'ã§': '61_de.glb', 'ã©': '62_do.glb',
      'ã°': '63_ba.glb', 'ã³': '64_bi.glb', 'ã¶': '65_bu.glb', 'ã¹': '66_be.glb', 'ã¼': '67_bo.glb',
      'ã±': '68_pa.glb', 'ã´': '69_pi.glb', 'ã·': '70_pu.glb', 'ãº': '71_pe.glb', 'ã½': '72_po.glb',
      'ã‚ƒ': '73_xya.glb', 'ã‚…': '74_xyu.glb', 'ã‚‡': '75_xyo.glb', 'ã£': '76_xtsu.glb',
      'ã': '77_xa.glb', 'ãƒ': '78_xi.glb', 'ã…': '79_xu.glb', 'ã‡': '80_xe.glb', 'ã‰': '81_xo.glb',
      'ãƒ¼': '47_bar.glb',
      '1': 's1_fight.glb', '2': 's2_otukare.glb', '3': 's3_sugoi.glb', '4': 's4_hakusyu.glb', '5': 's5_seeyou.glb'
    };
    
    const ROW_ORDER = ['ã‚', 'ã‹', 'ã•', 'ãŸ', 'ãª', 'ã¯', 'ã¾', 'ã‚„', 'ã‚‰', 'ã‚', 'å°', 'S'];
    
    // ==========================================
    // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ°é”åˆ¤å®š
    // ==========================================
    
    // åˆ°é”ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’å–å¾—ï¼ˆlocalStorageã‹ã‚‰ï¼‰
    function getMaxStageReached() {
      try {
        const saved = localStorage.getItem('signDiverMaxStage');
        console.log(`[DEBUG] localStorage 'signDiverMaxStage':`, saved);
        const result = saved ? parseInt(saved) : 0;
        console.log(`[DEBUG] Parsed max stage:`, result);
        return result;
      } catch (e) {
        console.warn('localStorage access failed:', e);
        return 0;
      }
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ°é”ã‚’ä¿å­˜ï¼ˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ å´ã‹ã‚‰å‘¼ã°ã‚Œã‚‹æƒ³å®šï¼‰
    function saveMaxStageReached(stage) {
      try {
        const current = getMaxStageReached();
        console.log(`[DEBUG] saveMaxStageReached called: stage=${stage}, current=${current}`);
        if (stage > current) {
          localStorage.setItem('signDiverMaxStage', stage.toString());
          console.log(`âœ… New stage unlocked: ${stage}`);
          console.log(`[DEBUG] localStorage updated to:`, localStorage.getItem('signDiverMaxStage'));
        } else {
          console.log(`[DEBUG] Stage ${stage} already unlocked (current: ${current})`);
        }
      } catch (e) {
        console.warn('localStorage save failed:', e);
      }
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ ã‹ã‚‰å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ï¼‰
    window.saveMaxStageReached = saveMaxStageReached;
    
    // ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ãŒã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹ã‹åˆ¤å®š
    function isStageUnlocked(stageNum) {
      const maxStage = getMaxStageReached();
      const unlocked = stageNum <= maxStage;
      console.log(`[DEBUG] isStageUnlocked(${stageNum}): maxStage=${maxStage}, unlocked=${unlocked}`);
      return unlocked;
    }
    
    // å„æ–‡å­—ã®è¦šãˆæ–¹ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
    let CHARACTER_HINTS = {};
    
    // ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã§èªè­˜åˆ¤å®šã‚’è¡Œã†æ–‡å­—ï¼ˆæ¸…éŸ³ã®ã¿ï¼‰
    const JUDGEABLE_CHARS = [
      'ã‚', 'ã„', 'ã†', 'ãˆ', 'ãŠ',
      'ã‹', 'ã', 'ã', 'ã‘', 'ã“',
      'ã•', 'ã—', 'ã™', 'ã›', 'ã',
      'ãŸ', 'ã¡', 'ã¤', 'ã¦', 'ã¨',
      'ãª', 'ã«', 'ã¬', 'ã­', 'ã®',
      'ã¯', 'ã²', 'ãµ', 'ã¸', 'ã»',
      'ã¾', 'ã¿', 'ã‚€', 'ã‚', 'ã‚‚',
      'ã‚„', 'ã‚†', 'ã‚ˆ',
      'ã‚‰', 'ã‚Š', 'ã‚‹', 'ã‚Œ', 'ã‚',
      'ã‚', 'ã‚’', 'ã‚“'
    ];
    
    // ç¾åœ¨é¸æŠä¸­ã®æ–‡å­—ãŒåˆ¤å®šå¯¾è±¡ã‹ã©ã†ã‹
    function isJudgeable(char) {
      return JUDGEABLE_CHARS.includes(char);
    }
    
    // ==========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ==========================================
    let currentRow = 'ã‚';
    let currentCharIndex = 0;
    let currentChar = 'ã‚';
    let allCharacters = [];  // å…¨æ–‡å­—ã®ãƒ•ãƒ©ãƒƒãƒˆãƒªã‚¹ãƒˆ
    
    let model = null;
    let hands = null;
    let camera = null;
    let labelMap = {};
    
    let lastRecognized = '';
    let lastConfidence = 0;
    
    // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ï¼ˆ15ãƒ•ãƒ¬ãƒ¼ãƒ åˆ†ã®ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’è“„ç©ï¼‰
    let frameBuffer = [];
    const TARGET_FRAMES = 15;
    
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // ãƒ¢ãƒ¼ãƒ‰ç®¡ç†
    let currentMode = 'individual'; // 'individual' or 'random'
    
    // ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰ç”¨
    let randomModeActive = false;
    let randomCharPool = [];  // å‡ºé¡Œå¯¾è±¡ã®æ–‡å­—ãƒªã‚¹ãƒˆ
    let totalQuestions = 0;
    let correctAnswers = 0;
    let currentQuestionAnswered = false;  // ç¾åœ¨ã®å•é¡Œã«æ­£è§£ã—ãŸã‹
    
    // VRMè¡¨ç¤ºç”¨
    let vrmScene, vrmCamera, vrmRenderer, vrmControls, vrm;
    let mixer, action, exprAction, clock;
    let vrmInitialPosition, vrmInitialRotation;
    let isPaused = false;
    let initialCameraPosition, initialCameraTarget;
    let hairBones = [];
    let GLTFLoader, OrbitControls, VRMLoaderPlugin; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
    
    // ==========================================
    // è‹±èªãƒ©ãƒ™ãƒ«ã‹ã‚‰æ—¥æœ¬èªã¸ã®å¤‰æ›ãƒãƒƒãƒ—
    // ==========================================
    const romajiToHiragana = {
      // æ¸…éŸ³
      "a": "ã‚", "i": "ã„", "u": "ã†", "e": "ãˆ", "o": "ãŠ",
      "ka": "ã‹", "ki": "ã", "ku": "ã", "ke": "ã‘", "ko": "ã“",
      "sa": "ã•", "si": "ã—", "shi": "ã—", "su": "ã™", "se": "ã›", "so": "ã",
      "ta": "ãŸ", "ti": "ã¡", "chi": "ã¡", "tu": "ã¤", "tsu": "ã¤", "te": "ã¦", "to": "ã¨",
      "na": "ãª", "ni": "ã«", "nu": "ã¬", "ne": "ã­", "no": "ã®",
      "ha": "ã¯", "hi": "ã²", "hu": "ãµ", "fu": "ãµ", "he": "ã¸", "ho": "ã»",
      "ma": "ã¾", "mi": "ã¿", "mu": "ã‚€", "me": "ã‚", "mo": "ã‚‚",
      "ya": "ã‚„", "yu": "ã‚†", "yo": "ã‚ˆ",
      "ra": "ã‚‰", "ri": "ã‚Š", "ru": "ã‚‹", "re": "ã‚Œ", "ro": "ã‚",
      "wa": "ã‚", "wo": "ã‚’", "n": "ã‚“", "nn": "ã‚“",
      
      // æ¿éŸ³
      "ga": "ãŒ", "gi": "ã", "gu": "ã", "ge": "ã’", "go": "ã”",
      "za": "ã–", "zi": "ã˜", "ji": "ã˜", "zu": "ãš", "ze": "ãœ", "zo": "ã",
      "da": "ã ", "di": "ã¢", "du": "ã¥", "de": "ã§", "do": "ã©",
      "ba": "ã°", "bi": "ã³", "bu": "ã¶", "be": "ã¹", "bo": "ã¼",
      
      // åŠæ¿éŸ³
      "pa": "ã±", "pi": "ã´", "pu": "ã·", "pe": "ãº", "po": "ã½",
      
      // æ‹—éŸ³
      "kya": "ãã‚ƒ", "kyu": "ãã‚…", "kyo": "ãã‚‡",
      "sha": "ã—ã‚ƒ", "shu": "ã—ã‚…", "sho": "ã—ã‚‡",
      "cha": "ã¡ã‚ƒ", "chu": "ã¡ã‚…", "cho": "ã¡ã‚‡",
      "nya": "ã«ã‚ƒ", "nyu": "ã«ã‚…", "nyo": "ã«ã‚‡",
      "hya": "ã²ã‚ƒ", "hyu": "ã²ã‚…", "hyo": "ã²ã‚‡",
      "mya": "ã¿ã‚ƒ", "myu": "ã¿ã‚…", "myo": "ã¿ã‚‡",
      "rya": "ã‚Šã‚ƒ", "ryu": "ã‚Šã‚…", "ryo": "ã‚Šã‚‡",
      "gya": "ãã‚ƒ", "gyu": "ãã‚…", "gyo": "ãã‚‡",
      "ja": "ã˜ã‚ƒ", "ju": "ã˜ã‚…", "jo": "ã˜ã‚‡",
      "bya": "ã³ã‚ƒ", "byu": "ã³ã‚…", "byo": "ã³ã‚‡",
      "pya": "ã´ã‚ƒ", "pyu": "ã´ã‚…", "pyo": "ã´ã‚‡",
      
      // å°æ–‡å­—ã²ã‚‰ãŒãªå˜ä½“
      "xa": "ã",  "xi": "ãƒ",  "xu": "ã…",  "xe": "ã‡",  "xo": "ã‰",
      "la": "ã",  "li": "ãƒ",  "lu": "ã…",  "le": "ã‡",  "lo": "ã‰",
      "xya": "ã‚ƒ", "xyu": "ã‚…", "xyo": "ã‚‡",
      "lya": "ã‚ƒ", "lyu": "ã‚…", "lyo": "ã‚‡",
      "xtu": "ã£", "xtsu": "ã£",
      "ltu": "ã£", "ltsu": "ã£",
      "xwa": "ã‚", "lwa": "ã‚",
      
      // é•·éŸ³è¨˜å·
      "bar": "ãƒ¼"
    };
    
    // ==========================================
    // è‹±èªãƒ©ãƒ™ãƒ«ã‚’ã²ã‚‰ãŒãªã«å¤‰æ›
    // ==========================================
    function convertToHiragana(sign) {
      // ã™ã§ã«æ—¥æœ¬èªã®å ´åˆã¯ãã®ã¾ã¾
      if (romajiToHiragana[sign]) {
        return romajiToHiragana[sign];
      }
      return sign;
    }
    
    // ==========================================
    // è¦šãˆæ–¹ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿
    // ==========================================
    async function loadCharacterHints() {
      try {
        const cacheBuster = `?v=${Date.now()}`;
        const response = await fetch(`./data/character_hints.txt${cacheBuster}`);
        const text = await response.text();
        
        CHARACTER_HINTS = {};
        text.split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0 && line.includes('|'))
          .forEach(line => {
            const [char, hint] = line.split('|').map(s => s.trim());
            if (char && hint) {
              CHARACTER_HINTS[char] = hint;
            }
          });
        
        console.log('âœ… è¦šãˆæ–¹ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(CHARACTER_HINTS).length, 'æ–‡å­—');
      } catch (error) {
        console.error('è¦šãˆæ–¹ã‚³ãƒ¡ãƒ³ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼ˆã‚³ãƒ¡ãƒ³ãƒˆãªã—ã§å‹•ä½œï¼‰
        CHARACTER_HINTS = {};
      }
    }
    
    // ==========================================
    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    // ==========================================
    async function switchMode(mode) {
      currentMode = mode;
      
      // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      document.getElementById('modeIndividual').classList.toggle('active', mode === 'individual');
      document.getElementById('modeRandom').classList.toggle('active', mode === 'random');
      
      if (mode === 'individual') {
        // å€‹åˆ¥ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰
        document.getElementById('characterSelector').style.display = 'block';
        document.getElementById('randomModeUI').style.display = 'none';
        document.querySelector('.navigation').style.display = 'flex';
        document.getElementById('prevBtn').style.display = 'inline-block';
        document.getElementById('nextBtn').style.display = 'inline-block';
        randomModeActive = false;
        
        // ç¾åœ¨ã®æ–‡å­—ã‚’å†é¸æŠï¼ˆUIã‚’ãƒªã‚»ãƒƒãƒˆã€ç”±æ¥ã‚³ãƒ¡ãƒ³ãƒˆã‚‚è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰
        selectCharacter(currentCharIndex);
        
      } else if (mode === 'random') {
        // ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰
        document.getElementById('characterSelector').style.display = 'none';
        document.getElementById('randomModeUI').style.display = 'block';
        document.querySelector('.navigation').style.display = 'flex';  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ãŸã‚è¡¨ç¤º
        document.getElementById('prevBtn').style.display = 'none';  // å‰ã¸ãƒœã‚¿ãƒ³éè¡¨ç¤º
        document.getElementById('nextBtn').style.display = 'none';  // æ¬¡ã¸ãƒœã‚¿ãƒ³éè¡¨ç¤º
        
        // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ï¼ˆå®Œäº†ã‚’å¾…ã¤ï¼‰
        await startRandomMode();
      }
    }
    
    // ==========================================
    // ãƒ©ãƒ³ãƒ€ãƒ å‡ºé¡Œãƒ¢ãƒ¼ãƒ‰
    // ==========================================
    async function startRandomMode() {
      randomModeActive = true;
      
      // çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
      totalQuestions = 0;
      correctAnswers = 0;
      currentQuestionAnswered = false;
      
      // å‡ºé¡Œå¯¾è±¡ã®æ–‡å­—ãƒªã‚¹ãƒˆï¼ˆæ¸…éŸ³ã®ã¿ï¼‰
      randomCharPool = [...JUDGEABLE_CHARS];
      
      // æœ€åˆã®æ–‡å­—ã‚’å‡ºé¡Œï¼ˆå®Œäº†ã‚’å¾…ã¤ï¼‰
      await nextRandomCharacter();
    }
    
    async function nextRandomCharacter() {
      if (randomCharPool.length === 0) {
        // å…¨æ–‡å­—çµ‚äº† - å€‹åˆ¥ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã‚‹
        switchMode('individual');
        return;
      }
      
      // ãƒ©ãƒ³ãƒ€ãƒ ã«æ–‡å­—ã‚’é¸æŠ
      const randomIndex = Math.floor(Math.random() * randomCharPool.length);
      currentChar = randomCharPool[randomIndex];
      
      // å‡ºé¡Œæ•°ã‚«ã‚¦ãƒ³ãƒˆ
      totalQuestions++;
      currentQuestionAnswered = false;
      
      // UIæ›´æ–°
      document.getElementById('randomCharDisplay').textContent = currentChar;
      
      // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ã§ã¯ç”±æ¥ã‚³ãƒ¡ãƒ³ãƒˆã‚’éè¡¨ç¤º
      const hintElement = document.getElementById('charHint');
      hintElement.style.display = 'none';
      
      // VRMãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆï¼ˆå®Œäº†ã‚’å¾…ã¤ï¼‰
      await switchVRMMotion(currentChar);
      
      // â˜… 1ãƒ•ãƒ¬ãƒ¼ãƒ å¾…ã£ã¦ã‹ã‚‰timeScale=0.0001ã§åœæ­¢
      // animate()ãŒæœ€ä½1å›å®Ÿè¡Œã•ã‚Œæ­£ã—ã„ãƒãƒ¼ã‚ºãŒæç”»ã•ã‚Œã¦ã‹ã‚‰ãƒ•ãƒªãƒ¼ã‚ºã™ã‚‹
      // timeScale=0ã§ã¯ãªã0.0001ã‚’ä½¿ã†ï¼ˆ0ã ã¨Three.jsãŒTãƒãƒ¼ã‚ºã‚’å‡ºã™ï¼‰
      await new Promise(resolve => requestAnimationFrame(() => {
        if (action && currentMode === 'random') {
          action.timeScale = 0.0001;
          if (exprAction) exprAction.timeScale = 0.0001;
          isPaused = true;
          console.log('[RANDOM] â¸ Frozen at', action.time.toFixed(3), 's (timeScale=0.0001)');
        }
        resolve();
      }));
      
      // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¯ãƒªã‚¢
      frameBuffer = [];
      
      // èªè­˜çµæœãƒªã‚»ãƒƒãƒˆ
      const resultArea = document.querySelector('.recognition-result');
      resultArea.classList.remove('disabled');
      updateUI('-', 0, 'waiting', 'æ‰‹ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„');
    }
    
    function updateRandomStats() {
      // çµ±è¨ˆæ›´æ–°ã¯ä¸è¦ã«ãªã£ãŸãŒã€é–¢æ•°ã¯æ®‹ã—ã¦ãŠãï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
    }
    
    function endRandomMode() {
      // çµ‚äº†æ©Ÿèƒ½ã¯ä¸è¦ã«ãªã£ãŸãŒã€é–¢æ•°ã¯æ®‹ã—ã¦ãŠãï¼ˆã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
      switchMode('individual');
    }
    
    // ==========================================
    // VRMè¡¨ç¤ºã®åˆæœŸåŒ–
    // ==========================================
    async function initVRM() {
      console.log('ğŸ“ VRM Display - Practice Mode');
      
      // Three.jsãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      const THREE = await import('three');
      window.THREE = THREE; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®šï¼ˆä»–ã®é–¢æ•°ã‹ã‚‰ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ï¼‰
      
      const { OrbitControls: OC } = await import('three/addons/controls/OrbitControls.js');
      const { GLTFLoader: GL } = await import('three/addons/loaders/GLTFLoader.js');
      const { VRMLoaderPlugin: VLP } = await import('@pixiv/three-vrm');
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä»£å…¥
      OrbitControls = OC;
      GLTFLoader = GL;
      VRMLoaderPlugin = VLP;
      
      const container = document.getElementById('vrm-canvas');

      // Clock for animation
      clock = new THREE.Clock();

      // Scene
      vrmScene = new THREE.Scene();
      vrmScene.background = new THREE.Color(0x87ceeb);
      vrmScene.fog = new THREE.Fog(0xc9e8f5, 8, 25);

      // Camera
      vrmCamera = new THREE.PerspectiveCamera(
        45,
        container.clientWidth / container.clientHeight,
        0.1,
        100
      );
      vrmCamera.position.set(0, 1.4, 1.4);
      
      console.log('ğŸ“· Initial camera position:', vrmCamera.position.toArray());

      // Renderer
      vrmRenderer = new THREE.WebGLRenderer({ antialias: true });
      vrmRenderer.setSize(container.clientWidth, container.clientHeight);
      vrmRenderer.setPixelRatio(window.devicePixelRatio);
      vrmRenderer.shadowMap.enabled = true;
      vrmRenderer.toneMapping = THREE.ACESFilmicToneMapping;
      vrmRenderer.toneMappingExposure = 1.5;
      vrmRenderer.outputColorSpace = THREE.SRGBColorSpace;
      container.appendChild(vrmRenderer.domElement);
      // â˜… canvasã‚’absoluteã«ã—ã¦ãƒœã‚¿ãƒ³ï¼ˆz-index:10ï¼‰ã‚ˆã‚ŠèƒŒé¢ã«ç½®ã
      vrmRenderer.domElement.style.position = 'absolute';
      vrmRenderer.domElement.style.top = '0';
      vrmRenderer.domElement.style.left = '0';
      vrmRenderer.domElement.style.zIndex = '1';

      // Controls
      vrmControls = new OrbitControls(vrmCamera, vrmRenderer.domElement);
      vrmControls.target.set(0, 1.2, 0);
      vrmControls.enableDamping = true;
      vrmControls.dampingFactor = 0.05;
      vrmControls.enablePan = true;
      vrmControls.update();
      
      console.log('ğŸ“· Camera target:', vrmControls.target.toArray());
      
      // ã‚«ãƒ¡ãƒ©ã®åˆæœŸä½ç½®ã¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ä¿å­˜
      initialCameraPosition = vrmCamera.position.clone();
      initialCameraTarget = vrmControls.target.clone();

      // Lights
      const directionalLight = new THREE.DirectionalLight(0xfff8f0, 2.2);
      directionalLight.position.set(2, 4, 3);
      directionalLight.castShadow = true;
      vrmScene.add(directionalLight);

      const directionalLight2 = new THREE.DirectionalLight(0xb0d8f8, 0.8);
      directionalLight2.position.set(-2, 2, -2);
      vrmScene.add(directionalLight2);

      const ambientLight = new THREE.AmbientLight(0xd0e8ff, 1.0);
      vrmScene.add(ambientLight);

      const hemisphereLight = new THREE.HemisphereLight(0x87ceeb, 0xd2b48c, 1.0);
      vrmScene.add(hemisphereLight);

      // Ground
      const groundGeometry = new THREE.PlaneGeometry(10, 10);
      const groundMaterial = new THREE.MeshStandardMaterial({ 
        color: 0xf5deb3,
        roughness: 0.8
      });
      const ground = new THREE.Mesh(groundGeometry, groundMaterial);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      vrmScene.add(ground);

      // Load VRM
      try {
        console.log('ğŸ“‚ Loading VRM from: ./vrm/Diver_Woman7.vrm');
        
        const loader = new GLTFLoader();
        loader.register((parser) => new VRMLoaderPlugin(parser));

        const gltf = await loader.loadAsync('./vrm/Diver_Woman7.vrm');
        vrm = gltf.userData.vrm;
        
        vrmScene.add(vrm.scene);
        
        // ã‚¹ãƒ—ãƒªãƒ³ã‚°ãƒœãƒ¼ãƒ³åˆæœŸåŒ–
        if (vrm.springBoneManager && vrm.springBoneManager.reset) {
          vrm.springBoneManager.reset();
        }
        for (let i = 0; i < 30; i++) {
          vrm.update(1 / 60);
        }
        
        // é«ªã®ãƒœãƒ¼ãƒ³ä¿®æ­£
        console.log('ğŸ”§ Fixing hair bone rotations...');
        let fixCount = 0;
        hairBones = [];
        vrm.scene.traverse((object) => {
          if (object.isBone && object.name.match(/J_Sec_Hair[123]_\d+$/)) {
            hairBones.push(object);
            
            const euler = object.rotation;
            const xDeg = Math.abs(euler.x * 180 / Math.PI);
            const zDeg = Math.abs(euler.z * 180 / Math.PI);
            
            if (xDeg > 170) {
              object.rotation.x = 0;
              fixCount++;
            }
            if (zDeg > 150) {
              object.rotation.z = 0;
              fixCount++;
            }
          }
        });
        console.log(`âœ… Fixed ${fixCount} extreme hair rotations (${hairBones.length} bones cached)`);
        
        // VRMåˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
        vrmInitialPosition = vrm.scene.position.clone();
        vrmInitialRotation = vrm.scene.quaternion.clone();
        
        // å½±ã®è¨­å®š
        vrm.scene.traverse((object) => {
          if (object.isMesh) {
            object.castShadow = true;
          }
        });

        console.log('âœ… VRM loaded successfully');
        
        // Load Motion - ç¾åœ¨é¸æŠä¸­ã®æ–‡å­—ã«å¯¾å¿œã™ã‚‹ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³
        const initialGlb = CHAR_TO_GLB[currentChar] || '01_a.glb';
        console.log(`ğŸ“‚ Loading motion for: ${currentChar} (${initialGlb})`);
        await loadMotion(`./glb/${initialGlb}`);

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤º
        const vrmLoader = document.getElementById('vrmLoadingOverlay');
        if (vrmLoader) vrmLoader.classList.add('hidden');
        
      } catch (error) {
        console.error('âŒ VRM load error:', error);
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’éè¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã«å§”ã­ã‚‹ï¼‰
        const vrmLoader = document.getElementById('vrmLoadingOverlay');
        if (vrmLoader) vrmLoader.classList.add('hidden');
      }

      // ç”»é¢ã‚¯ãƒªãƒƒã‚¯ã§å†ç”Ÿãƒ»åœæ­¢ãƒˆã‚°ãƒ«
      let mouseDownPos = null;
      let pausedTime = 0.05; // åœæ­¢æ™‚ã®timeä½ç½®
      
      vrmRenderer.domElement.addEventListener('mousedown', (e) => {
        mouseDownPos = { x: e.clientX, y: e.clientY };
        console.log('[CLICK] Mouse down at', e.clientX, e.clientY);
      });
      
      vrmRenderer.domElement.addEventListener('mouseup', (e) => {
        if (!mouseDownPos) return;
        
        const deltaX = Math.abs(e.clientX - mouseDownPos.x);
        const deltaY = Math.abs(e.clientY - mouseDownPos.y);
        
        console.log('[CLICK] Mouse up, delta:', deltaX, deltaY);
        
        if (deltaX < 5 && deltaY < 5) {
          console.log('[CLICK] Click detected (small movement)');
          if (action) {
            if (isPaused) {
              isPaused = false;
              action.timeScale = 1;
              if (exprAction) exprAction.timeScale = 1;
              console.log(`[CLICK] â–¶ Playing from ${action.time.toFixed(3)}s`);
            } else {
              isPaused = true;
              action.timeScale = 0.0001;
              if (exprAction) exprAction.timeScale = 0.0001;
              console.log(`[CLICK] â¸ Paused at ${action.time.toFixed(3)}s`);
            }
          }
        } else {
          console.log('[CLICK] Not a click (moved too much)');
        }
        
        mouseDownPos = null;
      });

      // Animation loop
      let lastIsPausedState = null;
      
      function animate() {
        requestAnimationFrame(animate);
        
        const delta = clock.getDelta();
        
        // isPausedã®çŠ¶æ…‹å¤‰åŒ–ã‚’ãƒ­ã‚°
        if (isPaused !== lastIsPausedState) {
          console.log(`[LOOP] isPaused changed: ${lastIsPausedState} â†’ ${isPaused}`);
          if (action) {
            console.log(`[LOOP] Action time: ${action.time.toFixed(3)}s`);
          }
          lastIsPausedState = isPaused;
        }
        
        vrmControls.update();
        
        // VRMæ›´æ–°ï¼ˆã‚¹ãƒ—ãƒªãƒ³ã‚°ãƒœãƒ¼ãƒ³å«ã‚å¸¸ã«deltaã§æ›´æ–°ï¼‰
        if (vrm) {
          vrm.update(delta);
        }
        
        // â˜… Mixeræ›´æ–°ï¼šå¸¸ã«mixer.update(delta)ã‚’å‘¼ã¶
        // isPausedæ™‚ã« mixer.update(0) ã‚’å‘¼ã¶ã¨Three.js r159ã§ã¯
        // ãƒœãƒ¼ãƒ³ã¸ã®æ›¸ãè¾¼ã¿ãŒç©ºã«ãªã‚ŠTãƒãƒ¼ã‚ºã«ãªã‚‹ï¼ˆæ—¢çŸ¥ã®ãƒã‚°ï¼‰
        // â†’ action.timeScale=0.0001ã«ã—ã¦ã€Œäº‹å®Ÿä¸Šåœæ­¢ã€ã—ã¤ã¤æ¯ãƒ•ãƒ¬ãƒ¼ãƒ æ­£ã—ãè©•ä¾¡ã•ã›ã‚‹
        if (mixer) {
          mixer.update(delta);
          
          if (!isPaused && action) {
            const duration = action.getClip().duration;
            if (action.time > duration - 0.05) {
              action.time = 0.05;
            }
          }
          
          updateSeekSlider();
        }
        
        // ãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å¯¾ç­–
        if (vrm && vrmInitialPosition && vrmInitialRotation) {
          vrm.scene.position.copy(vrmInitialPosition);
          vrm.scene.quaternion.copy(vrmInitialRotation);
        }
        
        // é«ªã®ãƒœãƒ¼ãƒ³å¯¾ç­–ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        if (hairBones.length > 0) {
          hairBones.forEach(bone => {
            const euler = bone.rotation;
            const xDeg = Math.abs(euler.x * 180 / Math.PI);
            const zDeg = Math.abs(euler.z * 180 / Math.PI);
            
            if (xDeg > 170) {
              bone.rotation.x = 0;
            }
            if (zDeg > 150) {
              bone.rotation.z = 0;
            }
          });
        }
        
        vrmRenderer.render(vrmScene, vrmCamera);
      }
      animate();
      
      // Resize
      window.addEventListener('resize', () => {
        const width = container.clientWidth;
        const height = container.clientHeight;
        
        vrmCamera.aspect = width / height;
        vrmCamera.updateProjectionMatrix();
        
        vrmRenderer.setSize(width, height);
      });
    }
    
    // ==========================================
    // ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆè¡¨ç¤ºï¼ˆãƒ­ãƒƒã‚¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰
    // ==========================================
    function showBlackout(char) {
      const overlay = document.getElementById('vrm-blackout');
      const title = document.getElementById('blackout-title');
      const message = document.getElementById('blackout-message');
      
      // ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
      if (SPECIAL_STAGE_NAMES[char]) {
        title.textContent = `${SPECIAL_STAGE_NAMES[char]} - ãƒ­ãƒƒã‚¯ä¸­`;
      } else {
        title.textContent = 'ã“ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™';
      }
      
      // è§£æ”¾æ¡ä»¶ã‚’å–å¾—ï¼ˆcharacter_hints.txtã‹ã‚‰ï¼‰
      const unlockCondition = CHARACTER_HINTS[char] || 'ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ ã§å¯¾å¿œã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã¨è§£æ”¾ã•ã‚Œã¾ã™ã€‚';
      message.textContent = unlockCondition;
      
      // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤º
      overlay.classList.add('show');
      
      console.log(`ğŸ”’ Locked content: ${char} (${SPECIAL_STAGE_NAMES[char] || char})`);
    }
    
    function hideBlackout() {
      const overlay = document.getElementById('vrm-blackout');
      overlay.classList.remove('show');
    }
    
    // ==========================================
    // VRMãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
    // ==========================================
    async function switchVRMMotion(char) {
      // å¯¾å¿œã™ã‚‹GLBãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
      const glbFile = CHAR_TO_GLB[char];
      
      if (!glbFile) {
        console.warn(`âš ï¸ No motion file for character: ${char}`);
        return;
      }
      
      const motionPath = `./glb/${glbFile}`;
      
      console.log(`ğŸ”„ Switching motion to: ${char} (${glbFile})`);
      
      // å¤ã„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯åœæ­¢ã›ãšã€æ–°ã—ã„ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã‚“ã§ã‹ã‚‰åˆ‡ã‚Šæ›¿ãˆ
      // ã“ã‚Œã«ã‚ˆã‚ŠTãƒãƒ¼ã‚ºãŒæ˜ ã‚‹ã®ã‚’é˜²ã
      await loadMotion(motionPath);
    }
    
    // ==========================================
    // ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿
    // ==========================================
    async function loadMotion(motionPath) {
      const THREE = window.THREE;
      
      try {
        console.log('');
        console.log('========================================');
        console.log('[LOAD] START loadMotion:', motionPath);
        console.log('[LOAD] currentMode:', currentMode);
        console.log('[LOAD] isPaused BEFORE:', isPaused);
        console.log('========================================');
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—ã¨ã®å¹²æ¸‰ã‚’é˜²ããŸã‚ã€ä¸€æ™‚çš„ã«åœæ­¢
        const wasPlaying = !isPaused;
        isPaused = true;
        console.log('[LOAD] Set isPaused = true temporarily');
        
        const gltfLoader = new GLTFLoader();
        
        // GLBèª­ã¿è¾¼ã¿
        const gltf = await gltfLoader.loadAsync(motionPath);
        
        console.log('[LOAD] âœ… GLB loaded');
        
        if (gltf.animations && gltf.animations.length > 0) {
          // animations[0]=éª¨, animations[1]=è¡¨æƒ…(weights) ã‚’ä¸¡æ–¹ãƒ­ãƒ¼ãƒ‰
          console.log(`[LOAD] animations: ${gltf.animations.map((a,i)=>`[${i}]${a.name}`).join(', ')}`);
          const boneClip = retargetExpressions(gltf.animations[0]);
          const exprClip = gltf.animations.length > 1 ? retargetExpressions(gltf.animations[1]) : null;
          if (exprClip) console.log('[LOAD] âœ… Expression animation found');
          
          console.log('[LOAD] Stopping old actions...');
          if (action) { action.stop(); action.enabled = false; action = null; }
          if (mixer)  { mixer.stopAllAction(); mixer = null; }
          
          console.log('[LOAD] Old actions stopped and cleared');
          
          // æ–°ã—ã„mixerã§éª¨ã‚¢ãƒ‹ãƒ¡ï¼‹è¡¨æƒ…ã‚¢ãƒ‹ãƒ¡ã‚’åŒæ™‚å†ç”Ÿ
          const newMixer = new THREE.AnimationMixer(vrm.scene);
          const newAction = newMixer.clipAction(boneClip);
          newAction.setLoop(THREE.LoopRepeat);
          newAction.clampWhenFinished = false;
          newAction.reset();
          newAction.play();
          
          // è¡¨æƒ…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åŒã˜ãƒŸã‚­ã‚µãƒ¼ã§åŒæœŸå†ç”Ÿ
          if (exprClip) {
            exprAction = newMixer.clipAction(exprClip);
            exprAction.setLoop(THREE.LoopRepeat);
            exprAction.clampWhenFinished = false;
            exprAction.reset();
            exprAction.play();
          } else {
            exprAction = null;
          }
          
          console.log('[LOAD] New action created and playing');
          
          // 0.05ç§’ã¾ã§é€²ã‚ã‚‹
          newMixer.update(0.05);
          
          // VRMã‚‚æ›´æ–°ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ï¼‰
          if (vrm) {
            vrm.update(0.05);
          }
          
          console.log('[LOAD] Advanced to:', newAction.time.toFixed(3), 's');
          
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’æ›´æ–°
          mixer = newMixer;
          action = newAction;
          
          console.log('[LOAD] Global variables updated');
          
          // ãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å¯¾ç­–ã‚’é©ç”¨
          if (vrm && vrmInitialPosition && vrmInitialRotation) {
            vrm.scene.position.copy(vrmInitialPosition);
            vrm.scene.quaternion.copy(vrmInitialRotation);
          }
          
          // é«ªã®ãƒœãƒ¼ãƒ³å¯¾ç­–ã‚’é©ç”¨
          if (hairBones.length > 0) {
            hairBones.forEach(bone => {
              const euler = bone.rotation;
              const xDeg = Math.abs(euler.x * 180 / Math.PI);
              const zDeg = Math.abs(euler.z * 180 / Math.PI);
              
              if (xDeg > 170) {
                bone.rotation.x = 0;
              }
              if (zDeg > 150) {
                bone.rotation.z = 0;
              }
            });
          }
          
          console.log('[LOAD] Corrections applied');
          
          // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å¼·åˆ¶å®Ÿè¡Œã—ã¦ãƒãƒ¼ã‚ºã‚’ç¢ºå®Ÿã«é©ç”¨
          if (vrmRenderer && vrmScene && vrmCamera) {
            vrmRenderer.render(vrmScene, vrmCamera);
            console.log('[LOAD] Rendering forced');
          }
          
          // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦åœæ­¢/å†ç”Ÿ
          if (currentMode === 'random') {
            isPaused = true;
            console.log('[LOAD] â¸ Setting isPaused = TRUE (random mode)');
            console.log('[LOAD] Paused at', newAction.time.toFixed(3), 's');
          } else {
            isPaused = false;
            console.log('[LOAD] â–¶ Setting isPaused = FALSE (normal mode)');
            console.log('[LOAD] Playing from', newAction.time.toFixed(3), 's');
          }
          
          console.log('[LOAD] âœ… Animation switched:', boneClip.name);
          console.log('[LOAD] Duration:', boneClip.duration);
          console.log('[LOAD] isPaused AFTER:', isPaused);
          console.log('========================================');
          console.log('[LOAD] Calling setupControls()...');
          
          setupControls();
          
          console.log('[LOAD] setupControls() completed');
          console.log('[LOAD] isPaused FINAL:', isPaused);
          console.log('[LOAD] END loadMotion');
          console.log('========================================');
          console.log('');
        }
        
      } catch (error) {
        console.error('âŒ Motion load error:', error);
      }
    }

    // ==========================================
    // è¡¨æƒ…ãƒˆãƒ©ãƒƒã‚¯ã®ãƒªã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°
    // ==========================================
    function retargetExpressions(originalClip) {
      const THREE = window.THREE;
      console.log('[INFO] Retargeting:', originalClip.name, '(', originalClip.tracks.length, 'tracks)');
      
      // VRMã«å­˜åœ¨ã™ã‚‹éª¨ãƒãƒ¼ãƒ‰åã‚’åé›†ï¼ˆå­˜åœ¨ã—ãªã„éª¨ã¯THREEè­¦å‘ŠãŒå‡ºã‚‹ãŸã‚é™¤å¤–ï¼‰
      const validBoneNames = new Set();
      vrm.scene.traverse((obj) => { if (obj.name) validBoneNames.add(obj.name); });
      
      const newTracks = [];
      let hairFiltered = 0, rootFiltered = 0, boneSkipped = 0, bonePassed = 0, morphPassed = 0;

      for (const track of originalClip.tracks) {
        // â‘  é«ªãƒœãƒ¼ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆæºã‚Œæš´èµ°é˜²æ­¢ï¼‰
        if (track.name.match(/J_Sec_Hair[123]_\d+\.(?:quaternion|rotation|position|scale)/)) {
          hairFiltered++; continue;
        }
        
        const isBoneTrack = track.name.includes('.position') ||
                            track.name.includes('.quaternion') ||
                            track.name.includes('.rotation') ||
                            track.name.includes('.scale');
        
        if (isBoneTrack) {
          // â‘¡ ãƒ«ãƒ¼ãƒˆãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä½ç½®ã‚ºãƒ¬é˜²æ­¢ï¼‰
          if (track.name.includes('Hips') || track.name.includes('Root') ||
              track.name.includes('mixamorig') || track.name.toLowerCase().includes('armature')) {
            rootFiltered++; continue;
          }
          // â‘¢ VRMã«å­˜åœ¨ã—ãªã„éª¨ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆTHREE.PropertyBindingè­¦å‘Šé˜²æ­¢ï¼‰
          const boneName = track.name.split('.')[0];
          if (!validBoneNames.has(boneName)) { boneSkipped++; continue; }
          newTracks.push(track.clone()); bonePassed++;
        } else {
          // â‘£ ãƒ¢ãƒ¼ãƒ•ãƒ»è¡¨æƒ…ãƒˆãƒ©ãƒƒã‚¯ï¼ˆmorphTargetInfluencesï¼‰ã¯å…¨é€šã—
          newTracks.push(track.clone()); morphPassed++;
        }
      }
      
      console.log(`   Total: ${originalClip.tracks.length}â†’${newTracks.length} | Hair:${hairFiltered} Root:${rootFiltered} BoneSkip:${boneSkipped} Bone:${bonePassed} Morph:${morphPassed}`);
      return new THREE.AnimationClip(originalClip.name, originalClip.duration, newTracks);
    }

    // ==========================================
    // UIã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«è¨­å®š
    // ==========================================
    function setupControls() {
      const playBtn = document.getElementById('vrm-playBtn');
      const pauseBtn = document.getElementById('vrm-pauseBtn');
      const resetCameraBtn = document.getElementById('vrm-resetCameraBtn');
      const seekSlider = document.getElementById('vrm-seekSlider');
      const speedSlider = document.getElementById('vrm-speedSlider');
      const speedDisplay = document.getElementById('vrm-speedDisplay');
      
      playBtn.addEventListener('click', () => {
        if (action) {
          isPaused = false;
          const ts = parseFloat(speedSlider.value) || 1;
          action.timeScale = ts;
          if (exprAction) exprAction.timeScale = ts;
          console.log('â–¶ Play');
        }
      });
      
      pauseBtn.addEventListener('click', () => {
        isPaused = true;
        if (action) action.timeScale = 0.0001;
        if (exprAction) exprAction.timeScale = 0.0001;
        console.log('â¸ Pause');
      });
      
      resetCameraBtn.addEventListener('click', () => {
        if (initialCameraPosition && initialCameraTarget) {
          vrmCamera.position.copy(initialCameraPosition);
          vrmControls.target.copy(initialCameraTarget);
          vrmControls.update();
          console.log('ğŸ“· Camera reset');
        }
      });
      
      seekSlider.addEventListener('input', (e) => {
        if (action) {
          const duration = action.getClip().duration;
          const targetTime = (e.target.value / 100) * duration;
          action.time = targetTime;
        }
      });
      
      speedSlider.addEventListener('input', (e) => {
        if (action) {
          const spd = parseFloat(e.target.value);
          action.timeScale = spd;
          if (exprAction) exprAction.timeScale = spd;
          speedDisplay.textContent = e.target.value + 'x';
        }
      });
    }

    // ==========================================
    // ã‚·ãƒ¼ã‚¯ãƒãƒ¼æ›´æ–°
    // ==========================================
    function updateSeekSlider() {
      if (!action) return;
      
      const seekSlider = document.getElementById('vrm-seekSlider');
      const timeDisplay = document.getElementById('vrm-timeDisplay');
      
      if (seekSlider && timeDisplay) {
        const duration = action.getClip().duration;
        const progress = (action.time / duration) * 100;
        
        seekSlider.value = progress;
        timeDisplay.textContent = `${action.time.toFixed(1)}s / ${duration.toFixed(1)}s`;
      }
    }
    
    // ==========================================
    // åˆæœŸåŒ–
    // ==========================================
    async function init() {
      // â”€â”€â”€ ã‚«ãƒ¡ãƒ©ä½¿ç”¨ç¢ºèª â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const cameraAllowed = await new Promise(resolve => {
        const modal  = document.getElementById('cameraModal');
        const yesBtn = document.getElementById('cameraYesBtn');
        const noBtn  = document.getElementById('cameraNoBtn');
        yesBtn.addEventListener('click', () => { modal.style.display = 'none'; resolve(true);  });
        noBtn.addEventListener('click',  () => {
          modal.style.display = 'none';
          // ã‚«ãƒ¡ãƒ©OFFè¡¨ç¤º
          const overlay = document.getElementById('cameraOffOverlay');
          if (overlay) overlay.style.display = 'flex';
          const status = document.getElementById('cameraStatus');
          if (status) status.style.display = 'none';
          document.getElementById('statusMessage').textContent = 'ã‚«ãƒ¡ãƒ©æœªä½¿ç”¨ãƒ¢ãƒ¼ãƒ‰';
          document.getElementById('statusMessage').className = 'status-message info';
          resolve(false);
        });
      });
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      try {
        // åˆ°é”ã‚¹ãƒ†ãƒ¼ã‚¸æƒ…å ±ã‚’è¡¨ç¤º
        console.log('');
        console.log('========================================');
        console.log('ğŸ† ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸åˆ°é”çŠ¶æ³');
        console.log('========================================');
        const maxStage = getMaxStageReached();
        console.log(`åˆ°é”ã‚¹ãƒ†ãƒ¼ã‚¸: ${maxStage}/5`);
        if (maxStage > 0) {
          const reachedStages = Array.from({length: maxStage}, (_, i) => SPECIAL_STAGE_NAMES[String(i+1)]).join(', ');
          console.log(`ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿: ${reachedStages}`);
        } else {
          console.log('ã¾ã ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ã«åˆ°é”ã—ã¦ã„ã¾ã›ã‚“');
          console.log('ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã‚²ãƒ¼ãƒ ã§ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã—ã¦ãã ã•ã„');
        }
        console.log('========================================');
        console.log('');
        
        // å…¨æ–‡å­—ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
        ROW_ORDER.forEach(rowKey => {
          allCharacters = allCharacters.concat(CHARACTER_ROWS[rowKey].chars);
        });
        
        // è¦šãˆæ–¹ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿
        await loadCharacterHints();
        
        if (cameraAllowed) {
          // ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ï¼ˆã‚«ãƒ¡ãƒ©ä½¿ç”¨æ™‚ã®ã¿ï¼‰
          console.log('ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...');
          const modelPath = '../80_siggame/03_model/tfjs_model_official/model.json';
          model = await tf.loadGraphModel(modelPath);
          console.log('âœ… ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿å®Œäº†');
          
          // ãƒ©ãƒ™ãƒ«ãƒãƒƒãƒ—èª­ã¿è¾¼ã¿
          const labelMapPath = '../80_siggame/03_model/label_map_unified.json';
          const labelRes = await fetch(labelMapPath);
          labelMap = await labelRes.json();
          console.log('âœ… ãƒ©ãƒ™ãƒ«ãƒãƒƒãƒ—èª­ã¿è¾¼ã¿å®Œäº†');
        } else {
          console.log('ğŸ“· ãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã‚«ãƒ¡ãƒ©ä¸ä½¿ç”¨ï¼‰');
        }
        
        if (cameraAllowed) {
          // MediaPipe HandsåˆæœŸåŒ–
          hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/${file}`
          });
          
          hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
          });
          
          hands.onResults(onHandsResults);
          
          // ã‚«ãƒ¡ãƒ©èµ·å‹•
          camera = new Camera(video, {
            onFrame: async () => {
              await hands.send({ image: video });
            },
            width: 640,
            height: 480
          });
          
          await camera.start();
          
          document.getElementById('cameraStatus').textContent = 'èªè­˜ä¸­';
          document.getElementById('cameraStatus').className = 'camera-status ready';
          console.log('âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•å®Œäº†');
        } else {
          console.log('ğŸ“· ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¹ã‚­ãƒƒãƒ—ï¼ˆä¸ä½¿ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼‰');
        }
        
        // VRMè¡¨ç¤ºã‚’åˆæœŸåŒ–
        await initVRM();
        console.log('âœ… VRMè¡¨ç¤ºåˆæœŸåŒ–å®Œäº†');
        
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ—¥æœ¬èªã§è¡¨ç¤º
        let errorMessage = 'ã‚«ãƒ¡ãƒ©ã¾ãŸã¯ãƒ¢ãƒ‡ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
        
        if (error.name === 'NotReadableError') {
          errorMessage = 'ã‚«ãƒ¡ãƒ©ãŒä½¿ç”¨ä¸­ã§ã™ã€‚ä»–ã®ã‚¢ãƒ—ãƒªï¼ˆZoomã€Teamsç­‰ï¼‰ã‚„ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚¿ãƒ–ã§ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã¯çµ‚äº†ã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚';
        } else if (error.name === 'NotAllowedError') {
          errorMessage = 'ã‚«ãƒ¡ãƒ©ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚';
        } else if (error.name === 'NotFoundError') {
          errorMessage = 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        }
        
        document.getElementById('cameraStatus').textContent = 'ã‚¨ãƒ©ãƒ¼';
        document.getElementById('cameraStatus').className = 'camera-status loading';
        document.getElementById('statusMessage').textContent = errorMessage;
        document.getElementById('statusMessage').className = 'status-message incorrect';
        
        // ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
          name: error.name,
          message: error.message
        });
      }
    }
    
    // ==========================================
    // MediaPipeçµæœå‡¦ç†
    // ==========================================
    function onHandsResults(results) {
      // Canvasã‚µã‚¤ã‚ºã‚’å‹•ç”»ã«åˆã‚ã›ã‚‹
      canvas.width = results.image.width;
      canvas.height = results.image.height;
      
      // å‹•ç”»ã‚’æç”»
      ctx.save();
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
      
      // æ‰‹ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆ
      if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        
        // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’æç”»
        drawConnectors(ctx, landmarks, HAND_CONNECTIONS, { color: '#00FF00', lineWidth: 2 });
        drawLandmarks(ctx, landmarks, { color: '#FF0000', lineWidth: 1, radius: 3 });
        
        // èªè­˜å‡¦ç†
        recognizeSign(landmarks);
      } else {
        // æ‰‹ãŒæ¤œå‡ºã•ã‚Œãªã„ - ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¯ãƒªã‚¢
        frameBuffer = [];
        lastRecognized = '';
        
        // åˆ¤å®šå¯¾è±¡å¤–ã®æ–‡å­—ã®å ´åˆã¯ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (!isJudgeable(currentChar)) {
          updateUI('-', 0, 'info', 'ğŸ’¡ ã“ã®æ–‡å­—ã¯ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã¯\nèªè­˜åˆ¤å®šã‚’è¡Œã„ã¾ã›ã‚“ã€‚\nå½¢ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        } else {
          updateUI('-', 0, 'waiting', 'æ‰‹ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„');
        }
      }
      
      ctx.restore();
    }
    
    // ==========================================
    // æŒ‡æ–‡å­—èªè­˜ï¼ˆtyping_game.htmlã¨åŒã˜å®Ÿè£…ï¼‰
    // ==========================================
    async function recognizeSign(landmarks) {
      if (!model) return;
      
      // åˆ¤å®šå¯¾è±¡å¤–ã®æ–‡å­—ã¯èªè­˜å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
      if (!isJudgeable(currentChar)) {
        return;
      }
      
      try {
        // ãƒ©ãƒ³ãƒ‰ãƒãƒ¼ã‚¯ã‚’63æ¬¡å…ƒã®ç‰¹å¾´é‡ã«å¤‰æ›
        const features = prepareInputData(landmarks);
        
        // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ã«è¿½åŠ 
        frameBuffer.push(features);
        if (frameBuffer.length > 20) {
          frameBuffer.shift();
        }
        
        // 15ãƒ•ãƒ¬ãƒ¼ãƒ æºœã¾ã‚‹ã¾ã§å¾…æ©Ÿ
        if (frameBuffer.length < TARGET_FRAMES) {
          updateUI('-', 0, 'waiting', 'æ‰‹ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„');
          return;
        }
        
        // 15ãƒ•ãƒ¬ãƒ¼ãƒ ã«ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
        const frames15 = resampleTo15(frameBuffer.slice(-18));
        const inputTensor = tf.tensor3d([frames15], [1, TARGET_FRAMES, 63]);
        
        // æ¨è«–
        const output = await model.executeAsync(inputTensor);
        const probs = await output.data();
        
        inputTensor.dispose();
        output.dispose();
        
        // æœ€å¤§ç¢ºç‡ã®ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
        const predId = Array.from(probs).indexOf(Math.max(...probs));
        const conf = probs[predId];
        const sign = labelMap.id_to_label[String(predId)];
        
        // è‹±èªãƒ©ãƒ™ãƒ«ã‚’æ—¥æœ¬èªã«å¤‰æ›
        const recognized = convertToHiragana(sign);
        const confidence = Math.round(conf * 100);
        
        lastRecognized = recognized;
        lastConfidence = confidence;
        
        // æ­£èª¤åˆ¤å®šï¼ˆä¿¡é ¼åº¦80%ä»¥ä¸Šã§åˆ¤å®šï¼‰
        if (conf >= 0.80) {
          if (recognized === currentChar) {
            updateUI(recognized, confidence, 'correct', 'âœ… æ­£è§£ï¼');
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æ­£è§£ã‚«ã‚¦ãƒ³ãƒˆ
            if (randomModeActive && !currentQuestionAnswered) {
              currentQuestionAnswered = true;
              correctAnswers++;
              
              // 1ç§’å¾Œã«è‡ªå‹•çš„ã«æ¬¡ã®æ–‡å­—ã¸
              setTimeout(() => {
                nextRandomCharacter();
              }, 1000);
            }
          } else {
            updateUI(recognized, confidence, 'incorrect', `ã€Œ${currentChar}ã€ã‚’ç·´ç¿’ä¸­...`);
          }
        } else {
          // ä¿¡é ¼åº¦ãŒä½ã„å ´åˆ
          updateUI('-', confidence, 'waiting', 'æ‰‹ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„');
        }
        
      } catch (error) {
        console.error('èªè­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ==========================================
    // 15ãƒ•ãƒ¬ãƒ¼ãƒ ã¸ã®ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
    // ==========================================
    function resampleTo15(frames) {
      const n = frames.length;
      if (n === TARGET_FRAMES) return frames;
      
      // ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ãŒå°‘ãªã„å ´åˆã¯æœ€å¾Œã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’è¤‡è£½
      if (n < TARGET_FRAMES) {
        const result = [...frames];
        while (result.length < TARGET_FRAMES) {
          result.push(frames[frames.length - 1]);
        }
        return result;
      }
      
      // ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ãŒå¤šã„å ´åˆã¯ç·šå½¢è£œé–“ã§ãƒªã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
      const indices = [];
      for (let i = 0; i < TARGET_FRAMES; i++) {
        indices.push(i * (n - 1) / (TARGET_FRAMES - 1));
      }
      
      return indices.map(idx => {
        const i0 = Math.floor(idx);
        const i1 = Math.min(i0 + 1, n - 1);
        const alpha = idx - i0;
        return frames[i0].map((v, j) => v * (1 - alpha) + frames[i1][j] * alpha);
      });
    }
    
    // ==========================================
    // å…¥åŠ›ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆtyping_game.htmlã®toFeature63ã¨åŒã˜ï¼‰
    // ==========================================
    function prepareInputData(landmarks) {
      const mirror = true; // ãƒŸãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ‰æœ‰åŠ¹ï¼ˆé‡è¦ï¼ï¼‰
      const wrist = landmarks[0];
      
      // 1. ãƒŸãƒ©ãƒ¼åè»¢ + æ‰‹é¦–åŸºæº–ã®ç›¸å¯¾åº§æ¨™åŒ–
      const pts = landmarks.map(p => ({
        x: (mirror ? (1.0 - p.x) : p.x) - (mirror ? (1.0 - wrist.x) : wrist.x),
        y: p.y - wrist.y,
        z: p.z - wrist.z
      }));
      
      // 2. æœ€å¤§è·é›¢ã§æ­£è¦åŒ–
      let maxd = 0;
      for (const p of pts) {
        const d = Math.sqrt(p.x * p.x + p.y * p.y + p.z * p.z);
        if (d > maxd) maxd = d;
      }
      
      const s = (maxd > 1e-9) ? (1.0 / maxd) : 1.0;
      const vec = [];
      for (const p of pts) {
        vec.push(p.x * s, p.y * s, p.z * s);
      }
      
      return vec;
    }
    
    // ==========================================
    // UIæ›´æ–°
    // ==========================================
    function updateUI(char, confidence, status, message) {
      document.getElementById('recognizedChar').textContent = char;
      document.getElementById('confidence').textContent = confidence > 0 ? `ä¿¡é ¼åº¦: ${confidence}%` : '-';
      
      const statusEl = document.getElementById('statusMessage');
      statusEl.textContent = message;
      statusEl.className = `status-message ${status}`;
    }
    
    // ==========================================
    // è¡Œé¸æŠUI
    // ==========================================
    function initRowSelector() {
      const container = document.getElementById('rowButtons');
      container.innerHTML = '';
      
      ROW_ORDER.forEach(rowKey => {
        const btn = document.createElement('button');
        btn.className = 'row-btn';
        btn.textContent = rowKey;
        if (rowKey === currentRow) btn.classList.add('active');
        
        btn.addEventListener('click', () => {
          selectRow(rowKey);
        });
        
        container.appendChild(btn);
      });
    }
    
    function selectRow(rowKey) {
      currentRow = rowKey;
      currentCharIndex = 0;  // è¡ŒãŒå¤‰ã‚ã£ãŸã‚‰æœ€åˆã®æ–‡å­—ã«
      
      // è¡Œãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      document.querySelectorAll('.row-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === rowKey);
      });
      
      // ãƒ©ãƒ™ãƒ«æ›´æ–°
      document.getElementById('currentRowLabel').textContent = `ï¼ˆã€Œ${CHARACTER_ROWS[rowKey].label}ã€ã‚’é¸æŠä¸­ï¼‰`;
      
      // æ–‡å­—ãƒœã‚¿ãƒ³ã‚’å†ç”Ÿæˆ
      initCharacterButtons();
      
      // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¯ãƒªã‚¢
      frameBuffer = [];
      
      // æœ€åˆã®æ–‡å­—ã‚’é¸æŠ
      selectCharacter(0);
    }
    
    // ==========================================
    // æ–‡å­—é¸æŠUI
    // ==========================================
    function initCharacterButtons() {
      const container = document.getElementById('charButtons');
      container.innerHTML = '';
      
      const chars = CHARACTER_ROWS[currentRow].chars;
      
      chars.forEach((char, index) => {
        const btn = document.createElement('button');
        btn.className = 'char-btn';
        btn.textContent = char;
        if (index === 0) btn.classList.add('active');
        
        // ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ã®å ´åˆã€ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’è¿½åŠ 
        if (currentRow === 'S') {
          btn.title = SPECIAL_STAGE_NAMES[char];
        }
        
        btn.addEventListener('click', () => {
          selectCharacter(index);
        });
        
        container.appendChild(btn);
        
        // 5å€‹ã”ã¨ã«æ”¹è¡Œï¼ˆæŠ˜ã‚Šè¿”ã—ï¼‰ã‚’æŒ¿å…¥
        if ((index + 1) % 5 === 0 && index < chars.length - 1) {
          const lineBreak = document.createElement('div');
          lineBreak.style.width = '100%';
          lineBreak.style.height = '0';
          container.appendChild(lineBreak);
        }
      });
    }
    
    function selectCharacter(index) {
      const chars = CHARACTER_ROWS[currentRow].chars;
      currentCharIndex = index;
      currentChar = chars[index];
      
      // ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’éè¡¨ç¤ºï¼ˆåˆ¥ã®æ–‡å­—ã«ç§»ã£ãŸæ™‚ã«è‡ªå‹•ã§é–‰ã˜ã‚‹ï¼‰
      hideBlackout();
      
      // UIæ›´æ–°ï¼ˆãƒ­ãƒƒã‚¯åˆ¤å®šã‚ˆã‚Šå‰ã«è¡Œã†ï¼‰
      document.getElementById('currentCharDisplay').textContent = currentChar;
      
      // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹æ›´æ–°
      document.querySelectorAll('.char-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === index);
      });
      
      // ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ã®å ´åˆã®å‡¦ç†
      if (currentRow === 'S') {
        console.log(`[DEBUG] Special stage selected: ${currentChar}`);
        
        // ãƒ’ãƒ³ãƒˆã‚’éè¡¨ç¤º
        const hintElement = document.getElementById('charHint');
        hintElement.style.display = 'none';
        
        // ãƒ­ãƒƒã‚¯åˆ¤å®š
        const stageNum = parseInt(currentChar);
        console.log(`[DEBUG] Stage number:`, stageNum);
        
        const unlocked = isStageUnlocked(stageNum);
        console.log(`[DEBUG] Unlock result:`, unlocked);
        
        if (!unlocked) {
          // ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã€ãƒ–ãƒ©ãƒƒã‚¯ã‚¢ã‚¦ãƒˆè¡¨ç¤ºã—ã¦å‡¦ç†ã‚’ä¸­æ–­
          console.log(`[DEBUG] Stage ${stageNum} is LOCKED - showing blackout`);
          showBlackout(currentChar);
          return;
        } else {
          console.log(`[DEBUG] Stage ${stageNum} is UNLOCKED - loading motion`);
        }
      }
      
      // ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°ï¼ˆã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¸ä»¥å¤–ï¼‰
      if (currentRow !== 'S') {
        const hint = CHARACTER_HINTS[currentChar] || '';
        const hintElement = document.getElementById('charHint');
        if (hint) {
          hintElement.textContent = hint;
          hintElement.style.display = 'block';
        } else {
          hintElement.style.display = 'none';
        }
      }
      
      // VRMãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ
      switchVRMMotion(currentChar);
      
      // ãƒ•ãƒ¬ãƒ¼ãƒ ãƒãƒƒãƒ•ã‚¡ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°ã—ã„æ–‡å­—ã®èªè­˜ã‚’é–‹å§‹ï¼‰
      frameBuffer = [];
      
      // åˆ¤å®šå¯¾è±¡å¤–ã®æ–‡å­—ã®å ´åˆ
      const resultArea = document.querySelector('.recognition-result');
      if (!isJudgeable(currentChar)) {
        resultArea.classList.add('disabled');
        updateUI('-', 0, 'info', 'ğŸ’¡ ã“ã®æ–‡å­—ã¯ç·´ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ã¯\nèªè­˜åˆ¤å®šã‚’è¡Œã„ã¾ã›ã‚“ã€‚\nå½¢ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      } else {
        resultArea.classList.remove('disabled');
        updateUI('-', 0, 'waiting', 'æ‰‹ã‚’ã‚«ãƒ¡ãƒ©ã«æ˜ ã—ã¦ãã ã•ã„');
      }
    }
    
    // ==========================================
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå‰ã¸ãƒ»æ¬¡ã¸ï¼‰
    // ==========================================
    document.getElementById('prevBtn').addEventListener('click', () => {
      // ç¾åœ¨ã®è¡Œã®æ–‡å­—æ•°
      const chars = CHARACTER_ROWS[currentRow].chars;
      
      if (currentCharIndex > 0) {
        // åŒã˜è¡Œã®å‰ã®æ–‡å­—ã¸
        selectCharacter(currentCharIndex - 1);
      } else {
        // å‰ã®è¡Œã®æœ€å¾Œã®æ–‡å­—ã¸
        const currentRowIndex = ROW_ORDER.indexOf(currentRow);
        if (currentRowIndex > 0) {
          const prevRow = ROW_ORDER[currentRowIndex - 1];
          selectRow(prevRow);
          const prevChars = CHARACTER_ROWS[prevRow].chars;
          selectCharacter(prevChars.length - 1);
        }
      }
    });
    
    document.getElementById('nextBtn').addEventListener('click', () => {
      // ç¾åœ¨ã®è¡Œã®æ–‡å­—æ•°
      const chars = CHARACTER_ROWS[currentRow].chars;
      
      if (currentCharIndex < chars.length - 1) {
        // åŒã˜è¡Œã®æ¬¡ã®æ–‡å­—ã¸
        selectCharacter(currentCharIndex + 1);
      } else {
        // æ¬¡ã®è¡Œã®æœ€åˆã®æ–‡å­—ã¸
        const currentRowIndex = ROW_ORDER.indexOf(currentRow);
        if (currentRowIndex < ROW_ORDER.length - 1) {
          const nextRow = ROW_ORDER[currentRowIndex + 1];
          selectRow(nextRow);
          selectCharacter(0);
        }
      }
    });
    
    // ==========================================
    // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆé–‹ç™ºè€…ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ä½¿ç”¨å¯èƒ½ï¼‰
    // ==========================================
    window.unlockStage = function(stage) {
      saveMaxStageReached(stage);
      console.log(`âœ… ã‚¹ãƒ†ãƒ¼ã‚¸ ${stage} ã¾ã§ã‚¢ãƒ³ãƒ­ãƒƒã‚¯ã—ã¾ã—ãŸ`);
      console.log('ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åæ˜ ã—ã¦ãã ã•ã„');
    };
    
    window.checkStageProgress = function() {
      const maxStage = getMaxStageReached();
      console.log(`ğŸ† ç¾åœ¨ã®åˆ°é”ã‚¹ãƒ†ãƒ¼ã‚¸: ${maxStage}/5`);
      for (let i = 1; i <= 5; i++) {
        const unlocked = isStageUnlocked(i);
        console.log(`  ${i}. ${SPECIAL_STAGE_NAMES[String(i)]}: ${unlocked ? 'âœ… ã‚¢ãƒ³ãƒ­ãƒƒã‚¯æ¸ˆã¿' : 'ğŸ”’ ãƒ­ãƒƒã‚¯ä¸­'}`);
      }
    };
    
    window.resetStageProgress = function() {
      localStorage.removeItem('signDiverMaxStage');
      console.log('âœ… ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡ŒçŠ¶æ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
      console.log('ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åæ˜ ã—ã¦ãã ã•ã„');
    };
    
    window.debugLocalStorage = function() {
      console.log('=== localStorage Debug ===');
      console.log('signDiverMaxStage:', localStorage.getItem('signDiverMaxStage'));
      console.log('Type:', typeof localStorage.getItem('signDiverMaxStage'));
      console.log('Parsed:', parseInt(localStorage.getItem('signDiverMaxStage')));
      console.log('All localStorage keys:', Object.keys(localStorage));
    };
    
    // ==========================================
    // èµ·å‹•
    // ==========================================
    initRowSelector();
    initCharacterButtons();
    
    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
    document.getElementById('modeIndividual').addEventListener('click', () => switchMode('individual'));
    document.getElementById('modeRandom').addEventListener('click', () => switchMode('random'));
    
    init();
  </script>
</body>
</html>
